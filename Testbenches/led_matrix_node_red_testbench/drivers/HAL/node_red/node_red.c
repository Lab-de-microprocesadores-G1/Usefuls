/*******************************************************************************
  @file     node_red.h
  @brief    node- red controller
  @author   G. Davidov, F. Farall, J. Gayt√°n, L. Kammann, N. Trozzo
 ******************************************************************************/

/*******************************************************************************
 * INCLUDE HEADER FILES
 ******************************************************************************/

#include "node_red.h"

#include "drivers/MCAL/uart/uart.h"

/*******************************************************************************
 * CONSTANT AND MACRO DEFINITIONS USING #DEFINE
 ******************************************************************************/
#define FRAMESIZE 		4

/*******************************************************************************
 * ENUMERATIONS AND STRUCTURES AND TYPEDEFS
 ******************************************************************************/


/*******************************************************************************
 * VARIABLES WITH GLOBAL SCOPE
 ******************************************************************************/

/*******************************************************************************
 * FUNCTION PROTOTYPES FOR PRIVATE FUNCTIONS WITH FILE LEVEL SCOPE
 ******************************************************************************/

static void updateColourCallback();
/*******************************************************************************
 * ROM CONST VARIABLES WITH FILE LEVEL SCOPE
 ******************************************************************************/

/*******************************************************************************
 * STATIC VARIABLES AND CONST VARIABLES WITH FILE LEVEL SCOPE
 ******************************************************************************/

static uart_cfg_t config = {
	.baudRate 		= UART_BAUD_RATE_9600,
	.length			= 0,
	.parityEnable	= 0,
	.parityMode		= 0,
	.stopMode		= 0
};

static node_red_pixel_t object_colour;
static bool new_value;

/*******************************************************************************
 *******************************************************************************
                        GLOBAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/

void nodeRedInit(void)
{
	//UART initialize
	uartInit(UART_INSTANCE_3, config);
	uartSubscribeRxMsg(UART_INSTANCE_3, updateColourCallback, FRAMESIZE);
	new_value = false;
}

node_red_pixel_t nodeRedGetValue()
{
	new_value = false;
	return object_colour;
}

bool nodeRedHasNewValue()
{
	return new_value;
}
/*******************************************************************************
 *******************************************************************************
                        LOCAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/

static void updateColourCallback()
{
	uint8_t length = uartGetRxMsgLength(UART_INSTANCE_3);
	uartReadMsg(UART_INSTANCE_3, &object_colour, length);
	new_value = true;
}

/*******************************************************************************
 *******************************************************************************
						            INTERRUPT SERVICE ROUTINES
 *******************************************************************************
 ******************************************************************************/

/******************************************************************************/
